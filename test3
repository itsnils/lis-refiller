import time
import pigpio
import tmc5130
import weighingring

p = tmc5130.Pump(51200)
pi = pigpio.pi()
ads0 = weighingring.WeighingRing(0)
ads1 = weighingring.WeighingRing(1)

for ring in [ads0, ads1]:
    ring.connect()
    ring.Zero = ring.Mean.mean(ring.read2())

LEDs = {"leftRed": 6,
        "leftGreen": 5,
        "rightRed": 19,
        "rightGreen": 13,
        "midRed": 26,
        "midGreen": 16,
        "midBlue": 20
        }

for i in LEDs:
    pi.write(LEDs[i], 0)

ads0.Sign = 1
ads1.Sign = -1

for i in range(16):
    for ring in [ads0, ads1]:
        ring.Zero = ring.Mean.mean(ring.read2())

while True:
    for ring in [ads0, ads1]:
        try:
            ring.Weight = ring.Mean.mean(ring.read2())
            ring.read_t()
        except pigpio.error:
            print("pigpio.error")
        else:
            if ring.Weight < ring.Zero and p.arrived():
                p.pump(5 * ring.Sign, 0.5)
                print("refilling ", ring.Sign)

    # print(round(ads0.Weight-ads0.Zero,1), round(ads1.Weight-ads1.Zero,1), round(p.TotalM,1), round(p.TotalP,1), round(ads0.Temperature,1), round(ads1.Temperature,1))
    try:
        print("%6.1f      %6.1f      %6.1f      %6.1f      %6.1f      %6.1f" % (ads0.Weight-ads0.Zero, ads1.Weight-ads1.Zero, float(p.TotalM), float(p.TotalP), float(ads0.Temperature), float(ads1.Temperature)))
        with open("weightlog1.txt", "a") as f:
            f.write("%6.1f, %6.1f, %6.1f, %6.1f, %6.1f, %6.1f, %6.1f %6.1f" % (ads0.Weight, ads0.Zero, p.TotalP, ads0.Temperature, ads1.Weight, ads1.Zero, p.TotalM, ads1.Temperature))
            f.write(" @,")
    except TypeError:
        print(type(ads0.Weight), type(ads0.Zero), type(ads1.Weight), type(ads1.Zero), type(p.TotalM), type(p.TotalP), type(ads0.Temperature), type(ads1.Temperature))
    time.sleep(0.5)










